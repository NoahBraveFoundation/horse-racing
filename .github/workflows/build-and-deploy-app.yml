name: Build and Deploy App

on:
  push:
    # branches: [main]
    paths:
      - "app/**"
      - ".github/workflows/build-and-deploy-app.yml"
  workflow_dispatch:
    inputs:
      release_notes:
        description: "Optional release notes uploaded alongside the TestFlight build"
        required: false
        default: ""

permissions:
  contents: read

env:
  APP_SCHEME: TicketScannerApp
  APP_PROJECT_PATH: TicketScannerApp/TicketScannerApp.xcodeproj
  APP_BUNDLE_ID: org.noahbrave.app.ticketscanner

jobs:
  testflight:
    name: Build & Upload TestFlight
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "26.0"

      - name: Validate required secrets
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          IOS_DISTRIBUTION_CERT_BASE64: ${{ secrets.IOS_DISTRIBUTION_CERT_BASE64 }}
          IOS_DISTRIBUTION_CERT_PASSWORD: ${{ secrets.IOS_DISTRIBUTION_CERT_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
          APPLE_TEAM_ID: ${{ vars.APPLE_TEAM_ID }}
        run: |
          missing=0
          for var in APP_STORE_CONNECT_API_KEY_ID APP_STORE_CONNECT_API_ISSUER_ID APP_STORE_CONNECT_API_KEY_BASE64 IOS_DISTRIBUTION_CERT_BASE64 IOS_DISTRIBUTION_CERT_PASSWORD IOS_PROVISIONING_PROFILE_BASE64 APPLE_TEAM_ID; do
            if [ -z "${!var}" ]; then
              echo "::error::Secret or variable $var is not configured."
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then
            exit 1
          fi

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        working-directory: app/TicketScannerApp
        run: xcodegen generate

      - name: Increment build number
        working-directory: app/TicketScannerApp
        run: agvtool new-version -all "$GITHUB_RUN_NUMBER"

      - name: Import signing certificate
        id: import_certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_DISTRIBUTION_CERT_BASE64 }}
          p12-password: ${{ secrets.IOS_DISTRIBUTION_CERT_PASSWORD }}

      - name: Install provisioning profile
        id: install_profile
        env:
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          set -eo pipefail
          PROFILE_PATH="$RUNNER_TEMP/profile.mobileprovision"
          echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > "$PROFILE_PATH"
          security cms -D -i "$PROFILE_PATH" > "$RUNNER_TEMP/profile.plist"
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print UUID' "$RUNNER_TEMP/profile.plist")
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print Name' "$RUNNER_TEMP/profile.plist")
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$PROFILE_PATH" "$HOME/Library/MobileDevice/Provisioning Profiles/$PROFILE_UUID.mobileprovision"
          echo "uuid=$PROFILE_UUID" >> "$GITHUB_OUTPUT"
          echo "name=$PROFILE_NAME" >> "$GITHUB_OUTPUT"

      - name: Save keychain path
        run: |
          KEYCHAIN_PATH="${{ steps.import_certificate.outputs.keychain-path }}"
          if [ -n "$KEYCHAIN_PATH" ]; then
            echo "IMPORTED_KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          else
            echo "::warning::apple-actions/import-codesign-certs did not set keychain-path output."
          fi

      - name: Determine code signing identity
        run: |
          set -eo pipefail
          if [ -z "$IMPORTED_KEYCHAIN_PATH" ] || [ ! -f "$IMPORTED_KEYCHAIN_PATH" ]; then
            echo "::error::Imported keychain path not found."
            exit 1
          fi
          IDENTITY=$(security find-identity -v -p codesigning "$IMPORTED_KEYCHAIN_PATH" | sed -n 's/.*"\(.*\)"/\1/p' | head -n1)
          if [ -z "$IDENTITY" ]; then
            echo "::error::No code signing identity found in imported keychain."
            exit 1
          fi
          echo "CODE_SIGN_IDENTITY=$IDENTITY" >> "$GITHUB_ENV"

      - name: Install fastlane
        run: sudo gem install fastlane --no-document

      - name: Build and upload with fastlane
        working-directory: app
        env:
          APPLE_TEAM_ID: ${{ vars.APPLE_TEAM_ID }}
          APP_SCHEME: ${{ env.APP_SCHEME }}
          APP_PROJECT_PATH: ${{ env.APP_PROJECT_PATH }}
          APP_BUNDLE_ID: ${{ env.APP_BUNDLE_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          PROFILE_UUID: ${{ steps.install_profile.outputs.uuid }}
          PROFILE_NAME: ${{ steps.install_profile.outputs.name }}
          CODE_SIGN_IDENTITY: ${{ env.CODE_SIGN_IDENTITY }}
          RELEASE_NOTES: ${{ github.event.inputs.release_notes || '' }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        run: |
          set -eo pipefail
          fastlane ios testflight

      - name: Upload fastlane logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fastlane-logs
          path: app/fastlane/logs
          if-no-files-found: warn

      - name: Clean up keychain
        if: always()
        run: |
          if [ -n "$IMPORTED_KEYCHAIN_PATH" ] && [ -f "$IMPORTED_KEYCHAIN_PATH" ]; then
            security delete-keychain "$IMPORTED_KEYCHAIN_PATH" || true
          fi
