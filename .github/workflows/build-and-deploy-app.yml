name: Build and Deploy App

on:
  push:
    # branches: [main]
    paths:
      - "app/**"
      - ".github/workflows/build-and-deploy-app.yml"
  workflow_dispatch:
    inputs:
      release_notes:
        description: "Optional release notes uploaded alongside the TestFlight build"
        required: false
        default: ""

permissions:
  contents: read

env:
  APP_SCHEME: TicketScannerApp
  APP_PROJECT_PATH: TicketScannerApp/TicketScannerApp.xcodeproj
  APP_BUNDLE_ID: org.noahbrave.app.ticketscanner

jobs:
  testflight:
    name: Build & Upload TestFlight
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "26.0"

      - name: Validate required secrets
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          IOS_DISTRIBUTION_CERT_BASE64: ${{ secrets.IOS_DISTRIBUTION_CERT_BASE64 }}
          IOS_DISTRIBUTION_CERT_PASSWORD: ${{ secrets.IOS_DISTRIBUTION_CERT_PASSWORD }}
          APPLE_TEAM_ID: ${{ vars.APPLE_TEAM_ID }}
        run: |
          missing=0
          for var in APP_STORE_CONNECT_API_KEY_ID APP_STORE_CONNECT_API_ISSUER_ID APP_STORE_CONNECT_API_KEY_BASE64 IOS_DISTRIBUTION_CERT_BASE64 IOS_DISTRIBUTION_CERT_PASSWORD APPLE_TEAM_ID; do
            if [ -z "${!var}" ]; then
              echo "::error::Secret or variable $var is not configured."
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then
            exit 1
          fi

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        working-directory: app/TicketScannerApp
        run: xcodegen generate

      - name: Increment build number
        working-directory: app/TicketScannerApp
        run: agvtool new-version -all "$GITHUB_RUN_NUMBER"

      - name: Import signing certificate
        id: import_certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_DISTRIBUTION_CERT_BASE64 }}
          p12-password: ${{ secrets.IOS_DISTRIBUTION_CERT_PASSWORD }}

      - name: Save keychain path
        run: |
          OUTPUTS_JSON='${{ toJson(steps.import_certificate.outputs) }}'
          KEYCHAIN_PATH=$(python3 -c "import json,sys; print(json.loads(sys.argv[1]).get('keychain-path',''))" "$OUTPUTS_JSON")
          if [ -n "$KEYCHAIN_PATH" ]; then
            echo "IMPORTED_KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          fi

      - name: Install fastlane
        run: sudo gem install fastlane --no-document

      - name: Build and upload with fastlane
        working-directory: app
        env:
          APPLE_TEAM_ID: ${{ vars.APPLE_TEAM_ID }}
          APP_SCHEME: ${{ env.APP_SCHEME }}
          APP_PROJECT_PATH: ${{ env.APP_PROJECT_PATH }}
          APP_BUNDLE_ID: ${{ env.APP_BUNDLE_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          RELEASE_NOTES: ${{ github.event.inputs.release_notes || '' }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        run: |
          set -eo pipefail
          fastlane ios testflight

      - name: Upload fastlane logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fastlane-logs
          path: app/fastlane/logs
          if-no-files-found: warn

      - name: Clean up keychain
        if: always()
        run: |
          if [ -n "$IMPORTED_KEYCHAIN_PATH" ] && [ -f "$IMPORTED_KEYCHAIN_PATH" ]; then
            security delete-keychain "$IMPORTED_KEYCHAIN_PATH" || true
          fi
